---
- name: Multi-OS Security Patching & Audit Reporting
  hosts: all
  become: yes
  vars:
    report_file: "/tmp/patch_audit_{{ lookup('pipe', 'date +%Y%m%d_%H%M') }}.csv"
    smtp_server: "smtp.gmail.com"
    smtp_port: 587
    smtp_user: "ignioservices@gmail.com"
    smtp_pass: "{{ vault_smtp_password }}" 
    email_recipient: "michael.obateru@cwg-plc.com"

  tasks:
    - name: 1. Initialize variables
      set_fact:
        patch_status: "No updates needed"
        reboot_required: "No"
        full_os_name: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
        actual_hostname: "{{ ansible_hostname | default(inventory_hostname) }}"

    # --- RHEL / CENTOS SECTION ---
    - name: 2. Patch RedHat Family
      block:
        - name: RHEL | Ensure yum-utils is present (for reboot check)
          package:
            name: yum-utils
            state: present
          when: ansible_distribution_major_version == "7"

        - name: RHEL | Upgrade Packages
          package:
            name: "*"
            state: latest
          register: rhel_out

        - name: RHEL | Check if reboot is required
          command: needs-restarting -r
          register: rhel_reboot_check
          ignore_errors: yes
          changed_when: false

        - name: RHEL | Record Status
          set_fact:
            patch_status: "{{ 'Success' if rhel_out.changed else 'No updates needed' }}"
            reboot_required: "{{ 'Yes' if rhel_reboot_check.rc | default(0) != 0 else 'No' }}"
      when: ansible_os_family == "RedHat"
      rescue:
        - set_fact:
            patch_status: "Failed"

    # --- DEBIAN / UBUNTU SECTION ---
    - name: 3. Patch Debian Family
      block:
        - name: Debian | Upgrade
          apt:
            upgrade: dist
            update_cache: yes
          register: deb_out

        - name: Debian | Check Reboot
          stat:
            path: /var/run/reboot-required
          register: reboot_file

        - name: Debian | Record Status
          set_fact:
            patch_status: "{{ 'Success' if deb_out.changed else 'No updates needed' }}"
            reboot_required: "{{ 'Yes' if reboot_file.stat.exists else 'No' }}"
      when: ansible_os_family == "Debian"
      rescue:
        - set_fact:
            patch_status: "Failed"

    # --- REPORT & EMAIL ---
    - name: 4. Build Report Header
      run_once: true
      delegate_to: localhost
      become: no
      copy:
        dest: "{{ report_file }}"
        content: "Hostname,IP,OS_Version,Status,Reboot_Required,Timestamp\n"

    - name: 5. Append host data to CSV
      delegate_to: localhost
      become: no
      lineinfile:
        path: "{{ report_file }}"
        line: "{{ actual_hostname }},{{ ansible_default_ipv4.address }},{{ full_os_name }},{{ patch_status }},{{ reboot_required }},{{ ansible_date_time.iso8601 }}"

    - name: 6. Send Email
      run_once: true
      delegate_to: localhost
      become: no
      community.general.mail:
        host: "{{ smtp_server }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_user }}"
        password: "{{ smtp_pass }}"
        secure: starttls
        to: "{{ email_recipient }}"
        subject: "PROD AUDIT: OS Patching Report"
        body: "Patching complete. Please find the attached audit report for your RHEL and Ubuntu fleet."
        attach: "{{ report_file }}"
