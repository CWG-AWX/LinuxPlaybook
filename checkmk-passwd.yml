---
- name: Complete Checkmk Agent Setup (Native Ansible)
  hosts: all
  become: yes

  vars:
    username: "testuser2"
    password_hash: !unsafe "$6$rounds=656000$yR/8S.6.R4M/f$yqV0/x7fT69vNisP6S6I/O5F7sNfNf6M0K4j9W.5JqE2T8jX6m9n7V.rO5L7oP3U1vG5M7Z9A8H1"
    plugin_dir: "/usr/lib/check_mk_agent/plugins"

  tasks:
    # --- 1. USER & PASSWORD EXPIRATION ---
    - name: Create test user with hashed password
      user:
        name: "{{ username }}"
        shell: /bin/bash
        create_home: yes
        password: "{{ password_hash }}"
        state: present

    - name: Set password to expire in 3 days
      shell: "chage -M 3 {{ username }}"
      changed_when: true

    # --- 2. FIREWALL (PORT 6556) ---
    - name: Open port 6556 in UFW (Ubuntu)
      ufw:
        rule: allow
        port: '6556'
        proto: tcp
      ignore_errors: yes

    - name: Open port 6556 in IPTables (Standard/RHEL)
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: '6556'
        jump: ACCEPT
        comment: "Allow Checkmk Agent"
      ignore_errors: yes

    # --- 3. PLUGIN DEPLOYMENT ----
    - name: Ensure Checkmk plugin directory exists
      file:
        path: "{{ plugin_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create mk-logins plugin file
      copy:
        dest: "{{ plugin_dir }}/mk-logins"
        mode: '0755'
        owner: root
        group: root
        content: |
          #!/bin/bash
          CMK_VERSION="2.4.0p20"
          if type who >/dev/null; then
              echo "<<<logins>>>"
              who | wc -l
          fi

    - name: Create mk-passwd plugin file
      copy:
        dest: "{{ plugin_dir }}/mk-passwd"
        mode: '0755'
        owner: root
        group: root
        content: |
          #!/bin/bash
          echo "<<<local:sep(0)>>>"
          while IFS=: read -r user _ uid _ _ _ _; do
              [[ "$uid" -lt 1000 ]] && continue
              expire=$(chage -l "$user" 2>/dev/null | awk -F": " '/Password expires/ {print $2}')
              [[ -z "$expire" || "$expire" == "never" ]] && continue
              days_left=$(( ( $(date -d "$expire" +%s) - $(date +%s) ) / 86400 ))
              if [ "$days_left" -le 1 ]; then state=2
              elif [ "$days_left" -le 3 ]; then state=1
              else state=0; fi
              echo "$state passwd_$user days_left=$days_left Password for user $user expires in $days_left day(s)"
          done < /etc/passwd

    # --- 4. VERIFICATION ---
    - name: Verify plugins and user status
      shell: "ls -l {{ plugin_dir }} && chage -l {{ username }} | grep 'Password expires'"
      register: final_verify
      changed_when: false

    - name: Summary Output
      debug:
        msg: "{{ final_verify.stdout_lines }}"
