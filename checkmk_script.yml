---
- name: Deploy Checkmk plugins for user password expiration and logins
  hosts: all
  become: yes

  vars:
    script_filename: "Checkmk_linux.txt"
    username: "testuser"

  tasks:

    - name: Get expiry epoch time (3 days from now)
      command: date -d "+3 days" +%s
      register: expiry_epoch
      changed_when: false

    - name: Create user that expires after 3 days
      user:
        name: "{{ username }}"
        shell: /bin/bash
        create_home: yes
        expires: "{{ expiry_epoch.stdout | int }}"
        state: present

    - name: Copy Checkmk script to server
      copy:
        src: "{{ script_filename }}"
        dest: "/tmp/{{ script_filename }}"
        mode: '0755'

    - name: Execute Checkmk script
      shell: bash /tmp/{{ script_filename }}
